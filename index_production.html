<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TelX - Social Network</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --tg-theme-bg-color: #1f2937;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #9ca3af;
            --tg-theme-link-color: #3b82f6;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #374151;
        }
        
        body {
            background-color: var(--tg-theme-bg-color, #1f2937);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
        }
        
        .app-screen { display: none; }
        .app-screen:not(.hidden) { display: block; }
        .nav-icon.active svg { color: var(--tg-theme-link-color, #3b82f6); }
        .feed-filter-btn.active { 
            background: linear-gradient(135deg, var(--tg-theme-button-color, #3b82f6), var(--tg-theme-link-color, #1d4ed8));
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .like-btn.liked { color: #ef4444; }
        .like-btn.liked svg { fill: currentColor; }
        
        /* Telegram theme adaptation */
        .bg-gray-900 { background-color: var(--tg-theme-bg-color, #1f2937) !important; }
        .bg-gray-800 { background-color: var(--tg-theme-secondary-bg-color, #374151) !important; }
        .bg-gray-700 { background-color: var(--tg-theme-secondary-bg-color, #374151) !important; }
        .text-white { color: var(--tg-theme-text-color, #ffffff) !important; }
        .text-gray-400 { color: var(--tg-theme-hint-color, #9ca3af) !important; }
        .text-blue-500 { color: var(--tg-theme-link-color, #3b82f6) !important; }
        .bg-blue-500 { background-color: var(--tg-theme-button-color, #3b82f6) !important; }
        
        /* Loading states */
        .loading { opacity: 0.6; pointer-events: none; }
        
        /* Smooth transitions */
        * { transition: all 0.2s ease; }
        
        /* Hide scrollbars */
        .hide-scrollbar { scrollbar-width: none; -ms-overflow-style: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
            <p class="text-white">Loading TelX...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden max-w-md mx-auto bg-gray-800 min-h-screen flex flex-col">
        <!-- Header -->
        <header id="app-header" class="bg-gray-800 border-b border-gray-600 px-4 py-3 flex items-center justify-between">
            <button id="back-button" class="hidden p-2 rounded-lg hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
            </button>
            <h1 id="header-title" class="text-xl font-bold text-white">TelX</h1>
            <button id="create-post-btn" class="p-2 rounded-lg hover:bg-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </header>

        <!-- Content Area -->
        <main class="flex-1 overflow-hidden">
            <!-- Feed Screen -->
            <div id="feed-screen" class="app-screen h-full flex flex-col">
                <!-- Filter Buttons -->
                <div class="p-4 bg-gray-800 border-b border-gray-600">
                    <div class="flex justify-between space-x-2">
                        <button class="feed-filter-btn flex-1 bg-gray-700/90 text-gray-300 px-3 py-2 rounded-lg text-sm font-medium border border-gray-600/50 hover:bg-gray-600 transition-all" data-filter="latest">
                            <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                        <button class="feed-filter-btn flex-1 bg-gray-700/90 text-gray-300 px-3 py-2 rounded-lg text-sm font-medium border border-gray-600/50 hover:bg-gray-600 transition-all" data-filter="fyp">
                            <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                            </svg>
                        </button>
                        <button class="feed-filter-btn flex-1 bg-gray-700/90 text-gray-300 px-3 py-2 rounded-lg text-sm font-medium border border-gray-600/50 hover:bg-gray-600 transition-all" data-filter="trending">
                            <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                        </button>
                        <button class="feed-filter-btn flex-1 bg-gray-700/90 text-gray-300 px-3 py-2 rounded-lg text-sm font-medium border border-gray-600/50 hover:bg-gray-600 transition-all" data-filter="following">
                            <svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Posts Container -->
                <div id="posts-container" class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar">
                    <!-- Posts will be rendered here -->
                </div>
            </div>

            <!-- Discover Screen -->
            <div id="discover-screen" class="app-screen h-full flex flex-col hidden">
                <div class="flex-1 overflow-y-auto hide-scrollbar">
                    <!-- Search Bar -->
                    <div class="p-4 bg-gray-800 border-b border-gray-600">
                        <input type="text" placeholder="Search users..." 
                               class="w-full bg-gray-700 text-white placeholder-gray-400 px-4 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none">
                    </div>
                    
                    <!-- Suggested Users -->
                    <div class="p-4">
                        <h2 class="text-lg font-bold text-white mb-4">Discover People</h2>
                        <div id="discover-users-list" class="space-y-3">
                            <!-- Users will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Screen -->
            <div id="profile-screen" class="app-screen h-full hidden">
                <div class="flex-1 overflow-y-auto hide-scrollbar">
                    <!-- Profile content will be rendered here -->
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bg-gray-800 border-t border-gray-600 px-4 py-2">
            <div class="flex justify-around">
                <button class="nav-icon p-3 rounded-lg hover:bg-gray-700" data-screen="feed-screen">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2V7z" />
                    </svg>
                </button>
                <button class="nav-icon p-3 rounded-lg hover:bg-gray-700" data-screen="discover-screen">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </button>
                <button class="nav-icon p-3 rounded-lg hover:bg-gray-700" data-screen="profile-screen" data-user-id="current">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </button>
            </div>
        </nav>
    </div>

    <!-- Create Post Modal -->
    <div id="create-post-screen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-gray-800 w-full rounded-t-2xl p-6 max-h-96">
            <div class="flex items-center justify-between mb-4">
                <button id="cancel-post-btn" class="text-gray-400 hover:text-white">Cancel</button>
                <h3 class="text-lg font-bold text-white">New Post</h3>
                <button id="submit-post-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg disabled:opacity-50" disabled>Post</button>
            </div>
            <textarea id="post-textarea" class="w-full bg-gray-700 text-white placeholder-gray-400 p-3 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none resize-none" 
                      placeholder="What's happening?" rows="4" maxlength="280"></textarea>
            <div class="flex justify-between items-center mt-3">
                <span id="char-counter" class="text-sm text-gray-400">0/280</span>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div id="comments-screen" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-end z-50">
        <div class="bg-gray-800 w-full h-96 rounded-t-2xl flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-600">
                <h3 class="text-lg font-bold text-white">Comments</h3>
                <button id="close-comments-btn" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="comments-content" class="flex-1 overflow-y-auto p-4 hide-scrollbar">
                <!-- Comments will be rendered here -->
            </div>
            <div class="p-4 border-t border-gray-600">
                <div class="flex space-x-3">
                    <input id="comment-input" type="text" placeholder="Add a comment..." 
                           class="flex-1 bg-gray-700 text-white placeholder-gray-400 px-3 py-2 rounded-lg border border-gray-600 focus:border-blue-500 focus:outline-none">
                    <button id="submit-comment-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Telegram WebApp SDK
        const tg = window.Telegram.WebApp;
        
        // Configure axios for API calls
        const API_BASE_URL = window.location.origin + '/api';
        
        // Global state
        const state = {
            currentUser: null,
            currentScreen: 'feed-screen',
            feedFilter: 'latest',
            posts: [],
            users: [],
            loading: false
        };

        // Telegram WebApp initialization
        function initTelegramWebApp() {
            tg.ready();
            tg.expand();
            
            // Apply Telegram theme
            if (tg.colorScheme) {
                document.documentElement.style.setProperty('--tg-theme-bg-color', tg.backgroundColor);
                document.documentElement.style.setProperty('--tg-theme-text-color', tg.textColor);
                document.documentElement.style.setProperty('--tg-theme-hint-color', tg.hintColor);
                document.documentElement.style.setProperty('--tg-theme-link-color', tg.linkColor);
                document.documentElement.style.setProperty('--tg-theme-button-color', tg.buttonColor);
                document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.buttonTextColor);
                document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.secondaryBackgroundColor);
            }
            
            // Authentication
            authenticateUser();
        }

        // API helper functions
        async function apiCall(endpoint, options = {}) {
            const config = {
                baseURL: API_BASE_URL,
                headers: {
                    'Content-Type': 'application/json',
                    ...(state.currentUser && { 'X-User-ID': state.currentUser.id })
                },
                ...options
            };
            
            try {
                const response = await axios(endpoint, config);
                return response.data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Authentication
        async function authenticateUser() {
            try {
                const initData = tg.initData || 'query_id=test&user=%7B%22id%22%3A123456789%2C%22first_name%22%3A%22Test%22%2C%22username%22%3A%22testuser%22%7D&auth_date=1234567890&hash=test';
                
                const response = await apiCall('/auth', {
                    method: 'POST',
                    data: { initData }
                });
                
                state.currentUser = response.user;
                showApp();
                await loadFeed();
                await loadUsers();
            } catch (error) {
                console.error('Authentication failed:', error);
                showError('Authentication failed. Please try again.');
            }
        }

        // UI functions
        function showApp() {
            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
        }

        function showError(message) {
            // Simple error display - in production you'd want a better UI
            alert(message);
        }

        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.app-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Show target screen
            document.getElementById(screenId).classList.remove('hidden');
            state.currentScreen = screenId;
            
            // Update header
            updateHeader(screenId);
            
            // Update navigation
            updateNavigation(screenId);
        }

        function updateHeader(screenId) {
            const backButton = document.getElementById('back-button');
            const headerTitle = document.getElementById('header-title');
            const createPostBtn = document.getElementById('create-post-btn');
            
            if (screenId === 'profile-screen') {
                backButton.classList.remove('hidden');
                createPostBtn.classList.add('hidden');
                headerTitle.textContent = "Profile";
            } else {
                backButton.classList.add('hidden');
                createPostBtn.classList.remove('hidden');
                headerTitle.textContent = "TelX";
            }
        }

        function updateNavigation(screenId) {
            document.querySelectorAll('.nav-icon').forEach(icon => {
                const iconSvg = icon.querySelector('svg');
                if (icon.dataset.screen === screenId) {
                    icon.classList.add('active');
                    iconSvg.classList.remove('text-gray-400');
                    iconSvg.classList.add('text-blue-500');
                } else {
                    icon.classList.remove('active');
                    iconSvg.classList.add('text-gray-400');
                    iconSvg.classList.remove('text-blue-500');
                }
            });
        }

        // Data loading functions
        async function loadFeed() {
            try {
                state.loading = true;
                const response = await apiCall(`/posts?filter=${state.feedFilter}`);
                state.posts = response.posts;
                renderPosts();
            } catch (error) {
                console.error('Failed to load feed:', error);
                showError('Failed to load posts. Please try again.');
            } finally {
                state.loading = false;
            }
        }

        async function loadUsers() {
            try {
                const response = await apiCall('/users');
                state.users = response.users;
                renderUsers();
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function loadUserProfile(userId) {
            try {
                const response = await apiCall(`/users/${userId}`);
                renderProfile(response.user, response.posts);
            } catch (error) {
                console.error('Failed to load user profile:', error);
                showError('Failed to load profile. Please try again.');
            }
        }

        // Rendering functions
        function renderPosts() {
            const container = document.getElementById('posts-container');
            
            if (state.posts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">📱</div>
                        <p class="text-gray-400 text-lg mb-2">No posts yet</p>
                        <p class="text-gray-500 text-sm">Be the first to share something!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = state.posts.map(post => `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center mb-3 cursor-pointer" onclick="navigateToProfile(${post.author.id})">
                        <img src="${post.author.photo_url || generateAvatar(post.author.first_name)}" 
                             class="w-10 h-10 rounded-full mr-3" 
                             onerror="this.src='${generateAvatar(post.author.first_name)}'">
                        <div>
                            <p class="font-semibold text-white">${post.author.full_name}</p>
                            <p class="text-xs text-gray-400">${post.author.handle} • ${timeSince(post.created_at)}</p>
                        </div>
                    </div>
                    <p class="text-white mb-3 leading-relaxed">${post.content}</p>
                    ${post.image_url ? `<img src="${post.image_url}" class="rounded-lg w-full h-auto mb-3" alt="Post image">` : ''}
                    <div class="flex justify-between items-center text-gray-400 border-t border-gray-600 pt-3">
                        <div class="flex items-center space-x-6">
                            <button class="like-btn flex items-center space-x-1 hover:text-red-500 transition-colors ${post.is_liked ? 'liked text-red-500' : ''}" 
                                    onclick="toggleLike(${post.id})">
                                <svg class="w-5 h-5" fill="${post.is_liked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                </svg>
                                <span id="likes-${post.id}">${formatNumber(post.likes_count)}</span>
                            </button>
                            <button class="comment-btn flex items-center space-x-1 hover:text-blue-500 transition-colors" 
                                    onclick="showComments(${post.id})">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                </svg>
                                <span>${formatNumber(post.comments_count)}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderUsers() {
            const container = document.getElementById('discover-users-list');
            
            container.innerHTML = state.users.map(user => `
                <div class="bg-gray-700 rounded-lg p-4">
                    <div class="flex items-center space-x-4">
                        <img src="${user.photo_url || generateAvatar(user.first_name)}" 
                             class="w-12 h-12 rounded-full cursor-pointer" 
                             onclick="navigateToProfile(${user.id})"
                             onerror="this.src='${generateAvatar(user.first_name)}'">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-semibold text-white truncate">${user.full_name}</h3>
                            <p class="text-sm text-gray-400">${user.handle}</p>
                            ${user.bio ? `<p class="text-sm text-gray-300 mt-1">${user.bio}</p>` : ''}
                            <div class="flex space-x-4 text-xs text-gray-400 mt-2">
                                <span>${formatNumber(user.followers_count)} followers</span>
                                <span>${formatNumber(user.posts_count)} posts</span>
                            </div>
                        </div>
                        <button onclick="toggleFollow(${user.id})" 
                                class="follow-btn px-4 py-2 rounded-lg text-sm font-semibold transition-colors ${user.is_following ? 'bg-gray-600 text-white hover:bg-gray-500' : 'bg-blue-500 text-white hover:bg-blue-600'}">
                            ${user.is_following ? 'Following' : 'Follow'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderProfile(user, posts) {
            const container = document.getElementById('profile-screen');
            
            container.innerHTML = `
                <div class="p-6 bg-gray-700/50">
                    <div class="text-center">
                        <img src="${user.photo_url || generateAvatar(user.first_name)}" 
                             class="w-20 h-20 rounded-full mx-auto mb-4 border-4 border-gray-600"
                             onerror="this.src='${generateAvatar(user.first_name)}'">
                        <h2 class="text-2xl font-bold text-white">${user.full_name}</h2>
                        <p class="text-sm text-gray-400 mb-3">${user.handle}</p>
                        ${user.bio ? `<p class="text-gray-300 max-w-xs mx-auto mb-4 leading-relaxed">${user.bio}</p>` : ''}
                        <div class="flex justify-center space-x-8 mb-6">
                            <div class="text-center">
                                <div class="font-bold text-white text-lg">${formatNumber(user.following_count)}</div>
                                <div class="text-gray-400 text-sm">Following</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-white text-lg">${formatNumber(user.followers_count)}</div>
                                <div class="text-gray-400 text-sm">Followers</div>
                            </div>
                            <div class="text-center">
                                <div class="font-bold text-white text-lg">${posts.length}</div>
                                <div class="text-gray-400 text-sm">Posts</div>
                            </div>
                        </div>
                        ${user.id !== state.currentUser.id ? `
                            <button onclick="toggleFollow(${user.id})" 
                                    class="w-full font-bold py-3 px-4 rounded-lg transition-colors ${user.is_following ? 'bg-gray-600 text-white hover:bg-gray-500' : 'bg-blue-500 text-white hover:bg-blue-600'}">
                                ${user.is_following ? 'Following' : 'Follow'}
                            </button>
                        ` : `
                            <button class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-500 transition-colors">
                                Edit Profile
                            </button>
                        `}
                    </div>
                </div>
                
                <div class="border-t border-gray-600">
                    <div class="p-4 bg-gray-700/30">
                        <h3 class="font-bold text-white text-lg mb-3">Posts</h3>
                    </div>
                    <div class="p-2 space-y-3">
                        ${posts.length > 0 ? posts.map(post => `
                            <div class="bg-gray-700 rounded-lg p-4">
                                <p class="text-white mb-3 leading-relaxed">${post.content}</p>
                                ${post.image_url ? `<img src="${post.image_url}" class="rounded-lg w-full h-auto mb-3" alt="Post image">` : ''}
                                <div class="flex justify-between items-center text-gray-400 border-t border-gray-600 pt-3">
                                    <div class="flex items-center space-x-6">
                                        <span class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                                            </svg>
                                            <span>${formatNumber(post.likes_count)}</span>
                                        </span>
                                        <span class="flex items-center space-x-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                                            </svg>
                                            <span>${formatNumber(post.comments_count)}</span>
                                        </span>
                                    </div>
                                    <span class="text-sm">${timeSince(post.created_at)}</span>
                                </div>
                            </div>
                        `).join('') : `
                            <div class="text-center py-12">
                                <div class="text-6xl mb-4">📝</div>
                                <p class="text-gray-400 text-lg mb-2">${user.id === state.currentUser.id ? "You haven't posted anything yet" : `${user.first_name} hasn't posted anything yet`}</p>
                                <p class="text-gray-500 text-sm">${user.id === state.currentUser.id ? "Share your first thought with the community!" : "Check back later for updates"}</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Action functions
        async function toggleLike(postId) {
            try {
                const response = await apiCall(`/posts/${postId}/like`, { method: 'POST' });
                
                // Update post in state
                const post = state.posts.find(p => p.id === postId);
                if (post) {
                    post.is_liked = response.is_liked;
                    post.likes_count = response.likes_count;
                    
                    // Update UI
                    const likesElement = document.getElementById(`likes-${postId}`);
                    if (likesElement) {
                        likesElement.textContent = formatNumber(response.likes_count);
                    }
                }
            } catch (error) {
                console.error('Failed to toggle like:', error);
            }
        }

        async function toggleFollow(userId) {
            try {
                const response = await apiCall(`/users/${userId}/follow`, { method: 'POST' });
                
                // Update user in state
                const user = state.users.find(u => u.id === userId);
                if (user) {
                    user.is_following = response.action === 'followed';
                    user.followers_count = response.user.followers_count;
                }
                
                // Re-render affected components
                if (state.currentScreen === 'discover-screen') {
                    renderUsers();
                } else if (state.currentScreen === 'profile-screen') {
                    await loadUserProfile(userId);
                }
            } catch (error) {
                console.error('Failed to toggle follow:', error);
            }
        }

        async function createPost(content) {
            try {
                const response = await apiCall('/posts', {
                    method: 'POST',
                    data: { content }
                });
                
                // Add to state
                state.posts.unshift(response.post);
                
                // Re-render if on feed
                if (state.currentScreen === 'feed-screen') {
                    renderPosts();
                }
                
                return response.post;
            } catch (error) {
                console.error('Failed to create post:', error);
                throw error;
            }
        }

        async function showComments(postId) {
            try {
                const response = await apiCall(`/posts/${postId}/comments`);
                renderComments(response.post, response.comments);
                document.getElementById('comments-screen').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load comments:', error);
            }
        }

        function renderComments(post, comments) {
            const container = document.getElementById('comments-content');
            
            container.innerHTML = `
                <!-- Original Post -->
                <div class="bg-gray-700 rounded-lg p-4 mb-4">
                    <div class="flex items-center mb-3">
                        <img src="${post.author.photo_url || generateAvatar(post.author.first_name)}" 
                             class="w-10 h-10 rounded-full mr-3"
                             onerror="this.src='${generateAvatar(post.author.first_name)}'">
                        <div>
                            <p class="font-semibold text-white">${post.author.full_name}</p>
                            <p class="text-xs text-gray-400">${post.author.handle} • ${timeSince(post.created_at)}</p>
                        </div>
                    </div>
                    <p class="text-white mb-3 leading-relaxed">${post.content}</p>
                    ${post.image_url ? `<img src="${post.image_url}" class="rounded-lg w-full h-auto mb-3" alt="Post image">` : ''}
                </div>
                
                <!-- Comments -->
                <div class="space-y-3">
                    <h3 class="text-white font-semibold text-lg mb-3">${comments.length > 0 ? 'Comments' : 'No comments yet'}</h3>
                    ${comments.map(comment => `
                        <div class="bg-gray-700/50 rounded-lg p-3">
                            <div class="flex items-start space-x-3">
                                <img src="${comment.author.photo_url || generateAvatar(comment.author.first_name)}" 
                                     class="w-8 h-8 rounded-full cursor-pointer" 
                                     onclick="navigateToProfile(${comment.author.id})"
                                     onerror="this.src='${generateAvatar(comment.author.first_name)}'">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <span class="font-semibold text-white text-sm">${comment.author.full_name}</span>
                                        <span class="text-xs text-gray-400">${timeSince(comment.created_at)}</span>
                                    </div>
                                    <p class="text-white text-sm">${comment.content}</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    ${comments.length === 0 ? '<div class="text-center py-8 text-gray-400"><p>Be the first to comment!</p></div>' : ''}
                </div>
            `;
        }

        // Navigation functions
        function navigateToProfile(userId) {
            loadUserProfile(userId);
            showScreen('profile-screen');
        }

        // Utility functions
        function generateAvatar(name) {
            return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=3b82f6&color=fff&size=80`;
        }

        function timeSince(dateString) {
            const date = new Date(dateString);
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            
            return Math.floor(seconds) + "s";
        }

        function formatNumber(num) {
            if (Math.abs(num) > 999) {
                return Math.sign(num) * ((Math.abs(num) / 1000).toFixed(1)) + 'k';
            }
            return Math.sign(num) * Math.abs(num);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Navigation
            document.querySelectorAll('.nav-icon').forEach(icon => {
                icon.addEventListener('click', () => {
                    const screenId = icon.dataset.screen;
                    if (screenId === 'profile-screen') {
                        navigateToProfile(state.currentUser.id);
                    } else {
                        showScreen(screenId);
                    }
                });
            });

            // Feed filters
            document.querySelectorAll('.feed-filter-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const filter = btn.dataset.filter;
                    state.feedFilter = filter;
                    
                    // Update button styles
                    document.querySelectorAll('.feed-filter-btn').forEach(b => {
                        b.classList.remove('active');
                        b.classList.add('bg-gray-700/90', 'text-gray-300');
                    });
                    btn.classList.add('active');
                    btn.classList.remove('bg-gray-700/90', 'text-gray-300');
                    
                    await loadFeed();
                });
            });

            // Create post
            document.getElementById('create-post-btn').addEventListener('click', () => {
                document.getElementById('create-post-screen').classList.remove('hidden');
                document.getElementById('post-textarea').focus();
            });

            document.getElementById('cancel-post-btn').addEventListener('click', () => {
                document.getElementById('create-post-screen').classList.add('hidden');
                document.getElementById('post-textarea').value = '';
                document.getElementById('char-counter').textContent = '0/280';
                document.getElementById('submit-post-btn').disabled = true;
            });

            // Post textarea
            document.getElementById('post-textarea').addEventListener('input', (e) => {
                const len = e.target.value.length;
                document.getElementById('char-counter').textContent = `${len}/280`;
                document.getElementById('submit-post-btn').disabled = len === 0 || len > 280;
                
                const counter = document.getElementById('char-counter');
                counter.classList.toggle('text-red-500', len > 280);
            });

            // Submit post
            document.getElementById('submit-post-btn').addEventListener('click', async () => {
                const content = document.getElementById('post-textarea').value.trim();
                if (content && content.length <= 280) {
                    try {
                        await createPost(content);
                        document.getElementById('cancel-post-btn').click();
                        showScreen('feed-screen');
                    } catch (error) {
                        showError('Failed to create post. Please try again.');
                    }
                }
            });

            // Comments
            document.getElementById('close-comments-btn').addEventListener('click', () => {
                document.getElementById('comments-screen').classList.add('hidden');
            });

            document.getElementById('comment-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('submit-comment-btn').click();
                }
            });

            // Back button
            document.getElementById('back-button').addEventListener('click', () => {
                showScreen('feed-screen');
            });

            // Search functionality
            const searchInput = document.querySelector('#discover-screen input[type="text"]');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    // Implement search filtering here
                });
            }
        });

        // Initialize app
        initTelegramWebApp();
        
        // Set initial filter to active
        document.querySelector('[data-filter="latest"]').classList.add('active');
        
        // Global functions for onclick handlers
        window.toggleLike = toggleLike;
        window.toggleFollow = toggleFollow;
        window.showComments = showComments;
        window.navigateToProfile = navigateToProfile;
    </script>
</body>
</html>
